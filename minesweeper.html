<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="mycss.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>MINESWEEPER</title>
    <script>
        //ë©”ì¸ë‹¨ì—ì„œ ì •ë³´ ë°›ì•„ì„œ ê°€ì§€ê³  ìˆëŠ” ë¡œì§ í•„ìš”(todo)
        // const url = location.href;
        // const temp = (url.split('?'))[1].split('');
        // const tempstring = (url.split('?'))[1];
        // const levelInfo=[];
        // console.log(temp);
        // console.log(tempstring);

        let land = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];
        let html = "<table id='land'>";//ì§€ë¢° í…Œì´ë¸” ìƒì„±í•˜ëŠ” html
        let sec =0; //timer
        let min =0;//timer
        let flagCount = 10;
        let safeField = 81-10;

        //ì§€ë¢° ê°¯ìˆ˜ë¥¼ ì¹´ìš´íŒ…í•˜ì—¬ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        function countingMine() {
            let mine = 0;
            for (let row of land) {
                for (let column of row) {
                    if (column == 'x') {
                        mine += 1;
                    }
                }
            }
            return mine;
        }

        //ëª¨ì„œë¦¬ ê°ì•ˆí•´ì„œ íƒìƒ‰ ì˜ì—­ ì°¾ì•„ì£¼ëŠ” í•¨ìˆ˜
        function rangeSearching(x, y){
            let arrange;
            if (x == 0 && y == 0) {//ì¢Œì¸¡ ë§¨ìœ„ ëª¨ì„œë¦¬
                arrange = [land[x][y + 1], land[x + 1][y], land[x + 1][y + 1]];
            } else if (x == 0 && y != 0 && y != 8) {//ë§¨ìœ„ ë²½ë©´
                arrange = [land[x][y - 1], land[x + 1][y - 1], land[x + 1][y], land[x + 1][y + 1], land[x][y + 1]];
            } else if (x == 0 && y == 8) {//ìš°ì¸¡ ë§¨ìœ„ ëª¨ì„œë¦¬
                arrange = [land[x][y - 1], land[x + 1][y - 1], land[x + 1][y]];
            } else if (x != 0 && x != 8 && y == 0) {//ìš°ì¸¡ ë²½ë©´
                arrange = [land[x - 1][y], land[x - 1][y + 1], land[x][y + 1], land[x + 1][y + 1], land[x + 1][y]];
            } else if (x != 0 && x != 8 && y == 8) {//ë§¨ì•„ë˜ ë²½ë©´
                arrange = [land[x - 1][y], land[x - 1][y - 1], land[x][y - 1], land[x + 1][y - 1], land[x + 1][y]];
            } else if (x == 8 && y == 0) {//ì¢Œì¸¡ ë§¨ì•„ë˜ ëª¨ì„œë¦¬
                arrange = [land[x - 1][y], land[x - 1][y + 1], land[x][y + 1]];
            } else if (x == 8 && y != 8 && y != 0) {//ì¢Œì¸¡ ë²½ë©´
                arrange = [land[x][y - 1], land[x - 1][y - 1], land[x - 1][y], land[x - 1][y + 1], land[x][y + 1]];
            } else if (x == 8 && y == 8) {//ìš°ì¸¡ ë§¨ì•„ë˜ ëª¨ì„œë¦¬
                arrange = [land[x][y - 1], land[x - 1][y - 1], land[x - 1][y]];
            } else { //ì£¼ìœ„ 8ì¹¸ ì „ë¶€ íƒìƒ‰
                arrange = [
                    land[x - 1][y - 1], land[x - 1][y], land[x - 1][y + 1],
                    land[x][y - 1], land[x][y], land[x][y + 1],
                    land[x + 1][y - 1], land[x + 1][y], land[x + 1][y + 1]
                ]
            }
            return arrange;
        }


        //ì„ íƒí•œ ì¢Œí‘œì˜ ì¸ê·¼ ì§€ë¢°ê°€ ëª‡ê°œ ìˆëŠ”ì§€ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        function countingNearMine(x, y) {
            let nearMine = 0;
            let arrange = rangeSearching(x,y);
            for (let i of arrange) {
                if (i == 'x') {
                    nearMine++;
                }
            }
            return nearMine;
        }

        //ì§€ë¢°ë¿Œë¦¬ê¸°
        while (countingMine() < 10) {
            land[Math.floor(Math.random() * 9)][Math.floor(Math.random() * 9)] = 'x';
        }

        //í•„ë“œì— ì¸ì ‘ ì§€ë¢° ê°¯ìˆ˜ ì¹´ìš´íŒ…í•˜ê¸°
        for (let row = 0; row < land.length; row++) {
            for (let column = 0; column < land[row].length; column++) {
                if (land[row][column] != 'x') {
                    land[row][column] = countingNearMine(row, column);
                }
            }
        }

        //htmlì— ì™„ì„±ëœ í•„ë“œ ë¿Œë¦¬ê¸°
        for (let row = 0; row < land.length; row++) {
            html += '<tr>';
            for (let column = 0; column < land[row].length; column++) {
                html += '<td class="hidden">' + land[row][column] + '</td>';
            }
            html += '</tr>';
        }
        html += '</table>';

        console.log(land);

    </script>
</head>

<body>
    <div class="circle"></div>
    <div class="tail" style="position:absolute; left:0; top:0; z-index:999;"></div>
    <header>
        <h2>ğŸ§¡Shall we begin?ğŸ§¡</h2>
    </header>

    <div id='body'>
        <ul id='game-inner-ul'>
            <li id='indicator-li'>
                <span class="indicator">TIME</span>
                <input type="text" value="00:00" id="time" class="form-control-style2">
                <span class="indicator">FLAG</span>
                <input type="text" value="999" id="flag" class="form-control-style2">
            </li>
            <li id='game'></li>
        </ul>
    </div>

</body>
<script>
    let timerStart= setInterval(timer,1000);//ì‹œê°„ ì‹œì‘
    document.querySelector('#game').innerHTML = html;//ê²Œì„ í•„ë“œ ë¿Œë¦¼
    document.querySelector('#flag').value = flagCount;
    document.addEventListener('contextmenu', function() {//ìš°í´ë¦­ì‹œ í¬ë¡¬ ê¸°ë³¸ ë©”ë‰´ì°½ ëœ¨ëŠ”ê²ƒ ë°©ì§€
        event.preventDefault();
    });

    //í•„ë“œ ì„ íƒí–ˆì„ ê²½ìš° ë™ì‘
    $('#land td').bind('click', function() { 

        let row = $(this).closest('tr').index(); 
        let column = $(this).closest('td').index(); 

        $('#land tr:eq('+row+')>td:eq('+column+')').removeClass('hidden');//í•„ë“œë¥¼ ì˜¤í”ˆí•˜ëŠ” í•¨ìˆ˜
        safeField--;
        if(safeField==0){
            win();
        }
        if(land[row][column]==0){
            //0ì¼ê²½ìš° ë³„ë„ì˜ ì¬ê·€í•¨ìˆ˜ í•„ìš”(todo)
        }else if(land[row][column]=='x'){//ì§€ë¢°ë¥¼ ëˆŒë €ì„ ê²½ìš°
            $('header >h2').html('ğŸ¤¯TouchÃ©!ğŸ¤¯');
            $('#land tr:eq('+row+')>td:eq('+column+')').addClass('red');//í´ë¦­í•œ ì§€ë¢°ì¹¸ì€ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
            for(let r=0;r<land.length;r++){
                for(let c=0;c<land[row].length;c++){
                    if(land[r][c]=='x'){
                        $('#land tr:eq('+r+')>td:eq('+c+')').removeClass('hidden');//í™”ë©´ì„ ì°¾ì•„ë‹¤ë‹ˆë©´ì„œ ì§€ë¢°ì¹¸ë“¤ë§Œ ì˜¤í”ˆ
                    }
                }
            }
            clearInterval(timerStart); //íƒ€ì´ë¨¸ ë©ˆì¶¤
            $('#land').addClass('defeat');//ì¡Œì„ ê²½ìš° ë”ì´ìƒ í•„ë“œ ì˜¤í”ˆ ë¶ˆê°€
        }
    });
    //ì´ê²¼ì„ ì‹œ í•¨ìˆ˜
    function win(){
        $('header >h2').html('ğŸ‘you did it!ğŸ‘');
        for(let r=0;r<land.length;r++){
                for(let c=0;c<land[row].length;c++){
                    if(land[r][c]=='x'){
                        $('#land tr:eq('+r+')>td:eq('+c+')').removeClass('hidden');//í™”ë©´ì„ ì°¾ì•„ë‹¤ë‹ˆë©´ì„œ ì§€ë¢°ì¹¸ë“¤ë§Œ ì˜¤í”ˆ
                    }
                }
            }
            clearInterval(timerStart); //íƒ€ì´ë¨¸ ë©ˆì¶¤
            $('#land').addClass('defeat');//ì¡Œì„ ê²½ìš° ë”ì´ìƒ í•„ë“œ ì˜¤í”ˆ ë¶ˆê°€
    }

    //ìš°í´ë¦­ì‹œ ê¹ƒë°œ ë‚˜ì˜¤ëŠ” í•¨ìˆ˜
    document.addEventListener('mousedown', function() {
        
        if ((event.button == 2) || (event.which == 3)) {
            if(flagCount==0){
                alert('ê¹ƒë°œì„ ë‹¤ ì¼ì–´ìš”...')
            }else{
                x = event.clientX;
                y = event.clientY; 
                flagCount--;
                document.querySelector('#flag').value = flagCount;
                $('<img>', {
	                src: 'lib/flag.png',
	                click: function(){ //ê¹ƒë°œ ì¬í´ë¦­ì‹œ ì‚¬ë¼ì§
                        flagCount++;
                        document.querySelector('#flag').value = flagCount;
                        $(this).remove();    
	                },
                    class:'flag'
                }).css({
                    cursor:'pointer',
                    width:'30px',
                    height:'30px',
	                position:'absolute',
                    left:x,
                    top:y
                }).appendTo('#body');
            }
        }          
    });
    

    //íƒ€ì´ë¨¸ ì‹¤í–‰ í•¨ìˆ˜
    function timer(){
        let timeString ="";
        if(sec==60){
             sec=0;
             min++;
         }else{
             sec++;
         } 
         timeString +=(min<10)?"0"+min:min;
         timeString +=(sec<10)?":0"+sec:":"+sec;
        $('#time').val(timeString);
     }

</script>
<script type="text/javascript" src="mouse.js"></script>
</html>